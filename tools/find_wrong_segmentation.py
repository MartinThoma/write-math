#!/usr/bin/env python

"""Check single symbol recordings for multiple symbols."""

from hwrt import segmentation
# import json
import pickle

import logging
import sys

logging.basicConfig(format='%(asctime)s %(levelname)s %(message)s',
                    level=logging.DEBUG,
                    stream=sys.stdout)

nn = segmentation.get_nn_classifier(None, None)
stroke_segmented_classifier = lambda X: nn(X)[0][1]
single_stroke_clf = None  # single_symbol_stroke_classifier()
single_clf = segmentation.single_classifier()


def main(raw_dataset):
    if len(raw_dataset['handwriting'].get_pointlist()) > 8:
        logging.warning('%i strokes in %s',
                        len(raw_dataset['handwriting'].get_pointlist()),
                        raw_dataset['handwriting'])
    seg_predict = segmentation.get_segmentation(raw_dataset['handwriting'].get_pointlist(),
                                                single_clf,
                                                single_stroke_clf,
                                                stroke_segmented_classifier)
    if len(seg_predict[0][0]) != 1:
        logging.info(raw_dataset)
        logging.info(seg_predict)


def load_raw(path_to_data):
    loaded = pickle.load(open(path_to_data, "rb"))
    raw_datasets = loaded['handwriting_datasets']
    return raw_datasets


if __name__ == '__main__':
    # data = """[[{"x":475,"y":313,"time":1433879103365},{"x":476,"y":313,"time":1433879103420},{"x":477,"y":313,"time":1433879103428},{"x":478,"y":313,"time":1433879103436},{"x":480,"y":312,"time":1433879103444},{"x":482,"y":311,"time":1433879103452},{"x":483,"y":311,"time":1433879103460},{"x":486,"y":310,"time":1433879103469},{"x":488,"y":309,"time":1433879103477},{"x":490,"y":309,"time":1433879103485},{"x":492,"y":308,"time":1433879103496},{"x":495,"y":308,"time":1433879103503},{"x":497,"y":308,"time":1433879103510},{"x":499,"y":308,"time":1433879103517},{"x":502,"y":307,"time":1433879103526},{"x":505,"y":307,"time":1433879103534},{"x":508,"y":308,"time":1433879103539},{"x":511,"y":308,"time":1433879103548},{"x":513,"y":308,"time":1433879103555},{"x":517,"y":308,"time":1433879103563},{"x":521,"y":308,"time":1433879103572},{"x":526,"y":308,"time":1433879103580},{"x":530,"y":308,"time":1433879103588},{"x":535,"y":307,"time":1433879103596},{"x":538,"y":307,"time":1433879103604},{"x":542,"y":307,"time":1433879103612},{"x":545,"y":307,"time":1433879103620},{"x":548,"y":307,"time":1433879103629},{"x":552,"y":307,"time":1433879103636},{"x":556,"y":307,"time":1433879103644},{"x":558,"y":307,"time":1433879103652},{"x":561,"y":306,"time":1433879103660},{"x":563,"y":306,"time":1433879103668},{"x":565,"y":306,"time":1433879103676},{"x":568,"y":305,"time":1433879103685},{"x":569,"y":304,"time":1433879103693},{"x":570,"y":304,"time":1433879103701},{"x":571,"y":303,"time":1433879103710},{"x":572,"y":303,"time":1433879103717},{"x":573,"y":303,"time":1433879103727}],[{"x":487,"y":350,"time":1433879104284},{"x":489,"y":349,"time":1433879104316},{"x":492,"y":349,"time":1433879104326},{"x":496,"y":347,"time":1433879104333},{"x":499,"y":347,"time":1433879104341},{"x":503,"y":346,"time":1433879104348},{"x":507,"y":345,"time":1433879104355},{"x":511,"y":345,"time":1433879104365},{"x":516,"y":345,"time":1433879104372},{"x":520,"y":345,"time":1433879104381},{"x":524,"y":345,"time":1433879104388},{"x":528,"y":345,"time":1433879104397},{"x":530,"y":345,"time":1433879104403},{"x":533,"y":345,"time":1433879104411},{"x":535,"y":345,"time":1433879104419},{"x":538,"y":345,"time":1433879104429},{"x":540,"y":345,"time":1433879104436},{"x":543,"y":345,"time":1433879104445},{"x":544,"y":345,"time":1433879104452},{"x":546,"y":345,"time":1433879104461},{"x":548,"y":345,"time":1433879104468},{"x":549,"y":344,"time":1433879104477},{"x":550,"y":344,"time":1433879104485},{"x":551,"y":344,"time":1433879104493},{"x":552,"y":344,"time":1433879104500},{"x":553,"y":344,"time":1433879104507},{"x":554,"y":344,"time":1433879104516},{"x":555,"y":344,"time":1433879104522},{"x":558,"y":345,"time":1433879104539},{"x":559,"y":345,"time":1433879104549},{"x":560,"y":345,"time":1433879104556},{"x":561,"y":346,"time":1433879104566},{"x":562,"y":346,"time":1433879104573},{"x":563,"y":346,"time":1433879104581},{"x":565,"y":346,"time":1433879104589},{"x":566,"y":346,"time":1433879104597},{"x":568,"y":346,"time":1433879104604},{"x":569,"y":346,"time":1433879104613},{"x":570,"y":346,"time":1433879104619},{"x":571,"y":346,"time":1433879104627},{"x":572,"y":346,"time":1433879104675},{"x":573,"y":346,"time":1433879104724}],[{"x":585,"y":286,"time":1433879106660},{"x":587,"y":286,"time":1433879106741},{"x":588,"y":286,"time":1433879106750},{"x":589,"y":287,"time":1433879106757},{"x":590,"y":287,"time":1433879106765},{"x":592,"y":289,"time":1433879106772},{"x":594,"y":290,"time":1433879106780},{"x":597,"y":292,"time":1433879106787},{"x":599,"y":294,"time":1433879106796},{"x":603,"y":298,"time":1433879106805},{"x":607,"y":301,"time":1433879106813},{"x":610,"y":305,"time":1433879106821},{"x":613,"y":309,"time":1433879106829},{"x":617,"y":312,"time":1433879106836},{"x":619,"y":314,"time":1433879106844},{"x":622,"y":316,"time":1433879106852},{"x":624,"y":318,"time":1433879106861},{"x":626,"y":319,"time":1433879106869},{"x":626,"y":320,"time":1433879106885},{"x":627,"y":320,"time":1433879106896},{"x":628,"y":321,"time":1433879106910},{"x":629,"y":322,"time":1433879106917},{"x":630,"y":323,"time":1433879106927},{"x":630,"y":324,"time":1433879106933},{"x":631,"y":325,"time":1433879106940},{"x":632,"y":326,"time":1433879106948},{"x":632,"y":327,"time":1433879106972},{"x":633,"y":327,"time":1433879107059},{"x":633,"y":329,"time":1433879107148},{"x":632,"y":331,"time":1433879107157},{"x":631,"y":333,"time":1433879107164},{"x":629,"y":335,"time":1433879107171},{"x":628,"y":337,"time":1433879107180},{"x":624,"y":341,"time":1433879107192},{"x":621,"y":344,"time":1433879107198},{"x":617,"y":348,"time":1433879107204},{"x":614,"y":351,"time":1433879107213},{"x":610,"y":354,"time":1433879107220},{"x":608,"y":356,"time":1433879107231},{"x":605,"y":359,"time":1433879107235},{"x":604,"y":361,"time":1433879107244},{"x":603,"y":362,"time":1433879107252},{"x":602,"y":363,"time":1433879107261},{"x":601,"y":363,"time":1433879107293},{"x":601,"y":364,"time":1433879107301},{"x":600,"y":364,"time":1433879107317},{"x":599,"y":365,"time":1433879107334}]]"""
    # data = json.loads(data)
    raw_pickle = '/home/moose/GitHub/hwr-experiments/raw-datasets/2015-04-14-10-04-handwriting_datasets-raw.pickle'
    logging.info('Start loading raw datasets...')
    raw_datasets = load_raw(raw_pickle)
    logging.info('Start analyzing...')
    for i, raw_dataset in enumerate(raw_datasets):
        if i % 100 == 0:
            print(i)
        main(raw_dataset)
